/*
 * Jugl.js -- JavaScript Template Library
 *
 * Copyright 2007 Tim Schaub
 * Released under the MIT license.  Please see
 * http://svn.tschaub.net/jugl/trunk/license.txt for the full license.
 */
(function(){var C={prefix:"jugl",namespaceURI:"http://namespace.jugl.org/"};var A={};A.object={extend:function(F,E){F=F||{};E=E||{};for(var D in E){F[D]=E[D]}return F},applyDefaults:function(F,E){F=F||{};E=E||{};for(var D in E){if(F[D]===undefined){F[D]=E[D]}}return F}};A.Class=function(){var E=function(){if(this===C){var I="Create an instance of a jugl class with the new keyword";throw Error(I)}this.initialize.apply(this,arguments)};var H={toString:function(){return"["+this.CLASS_NAME+"]"}};var D;for(var G=0,F=arguments.length;G<F;++G){if(typeof arguments[G]=="function"){D=arguments[G].prototype}else{D=arguments[G]}A.object.extend(H,D)}E.prototype=H;return E};A.Element=A.Class({template:null,node:null,scope:null,initialize:function(D,E){this.template=D;this.node=E;this.scope=new Object();this.scope.repeat=new Object()},clone:function(){var E=this.node.cloneNode(true);E.removeAttribute("id");var D=new A.Element(this.template,E);A.object.extend(D.scope,this.scope);return D},getAttribute:function(D){var F;if(this.node.nodeType==1){if(this.template.usingNS){F=this.node.getAttributeNodeNS(C.namespaceURI,D)}else{F=this.node.getAttributeNode(C.prefix+":"+D)}if(F&&!F.specified){F=false}}var E;if(F){E=new A.Attribute(this,F,D)}else{E=F}return E},setAttribute:function(D,E){this.node.setAttribute(D,E)},removeAttributeNode:function(D){this.node.removeAttributeNode(D.node)},getChildNodes:function(){var D=this.node.childNodes.length;var F=new Array(D);var H,G;for(var E=0;E<D;++E){H=new A.Element(this.template,this.node.childNodes[E]);H.scope=A.object.extend({},this.scope);F[E]=H}return F},removeChildNodes:function(){while(this.node.hasChildNodes()){this.node.removeChild(this.node.firstChild)}},removeChild:function(D){this.node.removeChild(D.node);return node},removeSelf:function(){this.node.parentNode.removeChild(this.node)},importNode:function(D){if(this.node.ownerDocument&&this.node.ownerDocument.importNode){if(D.node.ownerDocument!=this.node.ownerDocument){D.node=this.node.ownerDocument.importNode(D.node,true)}}},appendChild:function(D){this.importNode(D);this.node.appendChild(D.node)},insertAfter:function(E){this.importNode(E);var D=this.node.parentNode;var F=this.node.nextSibling;if(F){D.insertBefore(E.node,F)}else{D.appendChild(E.node)}},insertBefore:function(E){this.importNode(E);var D=this.node.parentNode;D.insertBefore(E.node,this.node)},process:function(){var F;var N=true;var G=["define","condition","repeat"];for(var J=0,L=G.length;J<L;++J){F=this.getAttribute(G[J]);if(F){try{N=F.process()}catch(H){A.console.error("Failed to process "+G[J]+" attribute");throw H}if(!N){return }}}var M=this.getAttribute("content");if(M){try{M.process()}catch(H){A.console.error("Failed to process content attribute");throw H}}else{var E=this.getAttribute("replace");if(E){try{E.process()}catch(H){A.console.error("Failed to process replace attribute");throw H}}}var I=this.getAttribute("attributes");if(I){try{I.process()}catch(H){A.console.error("Failed to process attributes attribute");throw H}}if(!M&&!E){this.processChildNodes()}var D=this.getAttribute("omit-tag");if(D){try{D.process()}catch(H){A.console.error("Failed to process omit-tag attribute");throw H}}var K=this.getAttribute("reflow");if(K){try{K.process()}catch(H){A.console.error("Failed to process reflow attribute");throw H}}},processChildNodes:function(){var F=this.getChildNodes();try{for(var E=0,D=F.length;E<D;++E){F[E].process()}}catch(G){A.console.error("Failed to process child node: "+E);throw G}},CLASS_NAME:"_jugl.Element"});A.console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){}};(function(){if(window.console){var D=document.getElementsByTagName("script");for(var E=0;E<D.length;++E){if(D[E].src.indexOf("firebug.js")!=-1){A.object.extend(A.console,console);break}}}})();A.request={loadTemplate:function(E,G,F){var D=function(K){var M,H;try{M=K.responseXML;H=new C.Template(M.documentElement)}catch(I){try{M=document.createElement("div");M.innerHTML=K.responseText;H=new C.Template(M.firstChild)}catch(L){var N="Can't make HTML out of response: "+K.responseText;A.console.error(N);throw L}}var J=A.func.bind(G,F);J(H)};A.request.loadUrl(E,D)},loadUrl:function(D,H,E){var G=(E)?A.func.bind(H,E):H;var F=A.request.createXMLHttpRequest();F.open("GET",D);F.onreadystatechange=function(){if(F.readyState==4){G(F)}};F.send(null)},createXMLHttpRequest:function(){if(typeof XMLHttpRequest!="undefined"){return new XMLHttpRequest()}else{if(typeof ActiveXObject!="undefined"){return new ActiveXObject("Microsoft.XMLHTTP")}else{throw new Error("XMLHttpRequest not supported")}}}};A.func={bind:function(H,G){var E=[];for(var F=2,D=arguments.length;F<D;++F){E.push(arguments[F])}return function(){for(var J=0,I=arguments.length;J<I;++J){E.push(arguments[J])}return H.apply(G,E)}}};A.node={appendChild:function(D,J){if(typeof (D)=="string"){var H=document.getElementById(D);if(!H){throw Error("Element id not found: "+D)}D=H}if(typeof (J)=="string"){var H=document.getElementById(J);if(!H){throw Error("Element id not found: "+J)}J=H}if(J.namespaceURI&&J.xml){var I=document.createElement("div");I.innerHTML=J.xml;var G=I.childNodes;for(var F=0,E=G.length;F<E;++F){D.appendChild(G[F])}}else{if(D.ownerDocument&&D.ownerDocument.importNode){J=D.ownerDocument.importNode(J,true)}D.appendChild(J)}return J}};C.Template=A.Class({node:null,usingNS:false,xhtmlns:"http://www.w3.org/1999/xhtml",xmldom:window.ActiveXObject?new ActiveXObject("Microsoft.XMLDOM"):null,regExes:{trimSpace:(/^\s*(\w+)\s+(.*?)\s*$/)},loaded:false,loading:false,initialize:function(D){if(typeof D=="string"||(D&&D.nodeType==1)){D={node:D}}D=D||{};if(typeof (D.node)=="string"){D.node=document.getElementById(D.node);if(!D.node){throw Error("Element id not found: "+D.node)}}if(D.node){this.node=D.node;this.loaded=true}else{if(D.url){this.load({url:D.url,callback:D.callback,scope:D.scope})}}},process:function(F){if(F&&!F.context&&!F.clone&&!F.string&&!F.parent){F={context:F}}F=A.object.applyDefaults(F,{context:null,clone:false,string:false});if(this.node.getAttributeNodeNS){if(this.node.getAttributeNodeNS(C.xhtmlns,C.prefix)){this.usingNS=true}}var E=new A.Element(this,this.node);if(F.clone){E=E.clone()}if(F.context){E.scope=F.context}try{E.process()}catch(G){A.console.error("Failed to process "+this.node.nodeName+" node");throw G}var H;if(F.string){if(E.node.innerHTML){H=E.node.innerHTML}else{if(this.xmldom){H=E.node.xml}else{var D=new XMLSerializer();H=D.serializeToString(E.node)}}}else{H=E.node;if(F.parent){if(F.clone){H=A.node.appendChild(F.parent,E.node)}else{this.appendTo(F.parent)}}}return H},load:function(E){if(typeof E=="string"){E={url:E}}E=E||{};this.loading=true;var D=function(F){this.node=F.node;this.loading=false;this.loaded=true;if(E.callback){E.callback.apply(E.scope,[F])}};A.request.loadTemplate(E.url,D,this)},appendTo:function(D){this.node=A.node.appendChild(D,this.node);return this},CLASS_NAME:"jugl.Template"});A.Attribute=A.Class({element:null,node:null,type:null,nodeValue:null,template:null,initialize:function(D,F,E){this.element=D;this.node=F;this.type=E;this.nodeValue=F.nodeValue;this.nodeName=F.nodeName;this.template=D.template},splitAttributeValue:function(F){F=(F!=null)?F:this.nodeValue;var E=this.template.regExes.trimSpace.exec(F);var D;if(E&&E.length==3){D=[E[1],E[2]]}return D},splitExpressionPrefix:function(){var D=this.splitAttributeValue();if(!D||(D[0]!="structure"&&D[0]!="text")){D=[null,this.nodeValue]}return D},getAttributeValues:function(){var F=this.nodeValue.replace(/[\t\n]/g,"").replace(/;\s*$/,"");var E=F.replace(/;;/g,"\t");var D=E.split(";").join("\n");return D.replace(/\t/g,";").split(/\n/g)},removeSelf:function(){this.element.removeAttributeNode(this)},process:function(){return this.processAttribute[this.type].apply(this,[])},evalInScope:function(E){var D="eval";return window[D]("with(this.element.scope){"+E+"}")},processAttribute:{define:function(){var F=this.getAttributeValues();var G;for(var E=0,D=F.length;E<D;++E){G=this.splitAttributeValue(F[E]);this.element.scope[G[0]]=this.evalInScope(G[1])}this.removeSelf();return true},condition:function(){var D;try{D=!!(this.evalInScope(this.nodeValue))}catch(F){var E=F.name+": "+F.message+"\nattribute: "+this.nodeName;A.console.error(E);throw F}this.removeSelf();if(!D){this.element.removeSelf()}return D},repeat:function(){var F=this.splitAttributeValue();var L=F[0];var I=this.evalInScope(F[1]);this.removeSelf();if(!(I instanceof Array)){var J=new Array();for(var D in I){J.push(D)}I=J}var E;var K=this.element;var H=I.length;for(var G=0;G<H;++G){E=this.element.clone();E.scope[L]=I[G];E.scope.repeat[L]={index:G,number:G+1,even:!(G%2),odd:!!(G%2),start:(G==0),end:(G==H-1),length:H};K.insertAfter(E);E.process();K=E}this.element.removeSelf();return false},content:function(){var I=this.splitExpressionPrefix();var M;try{M=this.evalInScope(I[1])}catch(H){A.console.error("Failed to eval in element scope: "+I[1]);throw H}this.removeSelf();if(I[0]=="structure"){try{this.element.node.innerHTML=M}catch(H){var D=document.createElement("div");var G;try{D.innerHTML=M}catch(O){G="Can't transform string into valid HTML : "+M;A.console.error(G);throw O}if(this.element.node.xml&&this.template.xmldom){while(this.element.node.firstChild){this.element.node.removeChild(this.element.node.firstChild)}this.template.xmldom.loadXML(D.outerHTML);var F=this.template.xmldom.firstChild.childNodes;try{for(var J=0,K=F.length;J<K;++J){this.element.node.appendChild(F[J])}}catch(L){G="Can't transform string into valid XHTML : "+M;A.console.error(G);throw L}}else{try{this.element.node.innerHTML=D.innerHTML}catch(L){G="Can't transform string into valid XHTML : "+M;A.console.error(G);throw L}}}}else{var N;if(this.element.node.xml&&this.template.xmldom){N=this.template.xmldom.createTextNode(M)}else{N=document.createTextNode(M)}var E=new A.Element(this.template,N);this.element.removeChildNodes();this.element.appendChild(E)}return true},replace:function(){var H=this.splitExpressionPrefix();var G;try{G=this.evalInScope(H[1])}catch(E){A.console.error("Failed to eval in element scope: "+H[1]);throw E}this.removeSelf();if(H[0]=="structure"){var J=document.createElement("div");try{J.innerHTML=G}catch(E){msg="Can't transform string into valid HTML : "+G;A.console.error(msg);throw E}if(this.element.node.xml&&this.template.xmldom){try{this.template.xmldom.loadXML(J.outerHTML)}catch(E){msg="Can't transform string into valid XML : "+G;A.console.error(msg);throw E}J=this.template.xmldom.firstChild}while(J.firstChild){var I=J.removeChild(J.firstChild);if(this.element.node.ownerDocument&&this.element.node.ownerDocument.importNode){if(I.ownerDocument!=this.element.node.ownerDocument){I=this.element.node.ownerDocument.importNode(I,true)}}this.element.node.parentNode.insertBefore(I,this.element.node)}}else{var F;if(this.element.node.xml&&this.template.xmldom){F=this.template.xmldom.createTextNode(G)}else{F=document.createTextNode(G)}var D=new A.Element(this.template,F);this.element.insertBefore(D)}this.element.removeSelf();return true},attributes:function(){var G=this.getAttributeValues();var I,E,H;for(var F=0,D=G.length;F<D;++F){I=this.splitAttributeValue(G[F]);E=I[0];H=this.evalInScope(I[1]);if(H!==false){this.element.setAttribute(E,H)}}this.removeSelf();return true},"omit-tag":function(){var H;try{H=((this.nodeValue=="")||!!(this.evalInScope(this.nodeValue)))}catch(G){A.console.error("Failed to eval in element scope: "+this.nodeValue);throw G}this.removeSelf();if(H){var F=this.element.getChildNodes();var I;for(var E=0,D=F.length;E<D;++E){this.element.insertBefore(F[E])}this.element.removeSelf()}},reflow:function(){var E;try{E=((this.nodeValue=="")||!!(this.evalInScope(this.nodeValue)))}catch(D){A.console.error("Failed to eval in element scope: "+this.nodeValue);throw D}this.removeSelf();if(E){if(this.element.node.outerHTML){this.element.node.outerHTML=this.element.node.outerHTML}else{this.element.node.innerHTML=this.element.node.innerHTML}}}},CLASS_NAME:"_jugl.Attribute"});var B="http://jugl.tschaub.net/trunk/lib/jugl.js";window[B]=C})();